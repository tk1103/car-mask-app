# Vercel環境でのレシート読み取り問題のトラブルシューティング

## 確認事項

### 1. 環境変数の設定確認

Vercelダッシュボードで以下を確認してください：

1. **プロジェクトのSettings > Environment Variables**を開く
2. `GEMINI_API_KEY`が設定されているか確認
3. 以下の環境すべてにチェックが入っているか確認：
   - ✅ Production
   - ✅ Preview
   - ✅ Development

**設定方法：**
- Name: `GEMINI_API_KEY`
- Value: あなたのGemini APIキー（`AIza...`で始まる文字列）
- Environment: すべてにチェック

### 2. 再デプロイの実行

環境変数を変更した場合は、**必ず再デプロイ**が必要です：

1. Vercelダッシュボードで「Deployments」タブを開く
2. 最新のデプロイメントの「...」メニューをクリック
3. 「Redeploy」を選択
4. または、GitHubにプッシュして自動デプロイをトリガー

### 3. Vercelのログを確認

1. Vercelダッシュボードで「Deployments」タブを開く
2. 最新のデプロイメントをクリック
3. 「Functions」タブを開く
4. `/api/ocr`をクリック
5. 「Logs」タブでエラーログを確認

**確認すべきログ：**
- `Environment check:` - APIキーが読み込まれているか
- `ERROR: GEMINI_API_KEY is not set` - 環境変数が設定されていない
- `Gemini API call failed` - API呼び出しのエラー

### 4. ブラウザのコンソールを確認

1. アプリを開く（例: `https://your-app.vercel.app`）
2. ブラウザの開発者ツールを開く（F12）
3. 「Console」タブを開く
4. 写真を撮影してOCR処理を実行
5. エラーメッセージを確認

**確認すべきエラー：**
- `OCR API error (500):` - サーバーエラー
- `OCR API error (401):` - 認証エラー（APIキー問題）
- `OCR API error (429):` - レート制限
- `OCR API error (503):` - サービス過負荷

### 5. よくある問題と解決方法

#### 問題1: APIキーが設定されていない

**症状：**
- エラーメッセージ: "APIキーの設定を確認してください"
- ログ: `ERROR: GEMINI_API_KEY is not set`

**解決方法：**
1. Vercelの環境変数設定を確認
2. `GEMINI_API_KEY`が正しく設定されているか確認
3. 再デプロイを実行

#### 問題2: APIキーが無効

**症状：**
- エラーメッセージ: "APIキーの認証に失敗しました"
- ログ: `Authentication failed`

**解決方法：**
1. [Google AI Studio](https://makersuite.google.com/app/apikey)でAPIキーを確認
2. 新しいAPIキーを生成
3. Vercelの環境変数を更新
4. 再デプロイを実行

#### 問題3: レート制限に達している

**症状：**
- エラーメッセージ: "APIの利用制限に達しました"
- ログ: `Quota exceeded`

**解決方法：**
1. 無料プランの場合は1日20リクエストの制限があります
2. 翌日まで待つか、有料プランにアップグレード

#### 問題4: モデルが利用できない

**症状：**
- エラーメッセージ: "指定されたモデルが見つかりませんでした"
- ログ: `404` または `not found`

**解決方法：**
1. `gemini-2.5-flash`が利用可能か確認
2. モデル名を確認（`src/app/api/ocr/route.ts`の82行目）

### 6. デバッグ用の改善点

コードに以下の改善を追加しました：

1. **Vercel環境の検出**: `process.env.VERCEL`でVercel環境を検出
2. **詳細なエラーメッセージ**: Vercel環境では環境変数の設定方法を明示
3. **ログの改善**: 環境変数の状態を詳細にログ出力
4. **エラーハンドリングの改善**: フロントエンドでエラーメッセージを確実に表示

### 7. テスト方法

1. **ローカル環境でテスト**:
   ```bash
   npm run dev
   ```
   - `.env.local`に`GEMINI_API_KEY`を設定
   - ローカルで動作確認

2. **Vercel環境でテスト**:
   - Vercelにデプロイ
   - ブラウザのコンソールでエラーを確認
   - Vercelのログでサーバー側のエラーを確認

### 8. サポートが必要な場合

以下の情報を提供してください：

1. **Vercelのログ**（`/api/ocr`のログ）
2. **ブラウザのコンソールエラー**
3. **環境変数の設定状態**（APIキーは含めない）
4. **発生しているエラーメッセージ**

## 次のステップ

1. 環境変数を確認・設定
2. 再デプロイを実行
3. ログを確認
4. エラーメッセージに基づいて対処
